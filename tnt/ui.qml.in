/*
    Copyright 2022 Benjamin Vedder	benjamin@vedder.se

    This file is part of VESC Tool.

    VESC Tool is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    VESC Tool is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
    */

import QtQuick 2.12
import QtQuick.Controls 2.12
import QtQuick.Layouts 1.3
import Qt.labs.settings 1.0

import Vedder.vesc.utility 1.0
import Vedder.vesc.commands 1.0
import Vedder.vesc.configparams 1.0

// This example shows how to read and write settings using the custom
// config. It is also possible to send and receive custom data using
// send_app_data and set_app_data_handler on the euc-side and Commands
// onCustomAppDataReceived and mCommands.sendCustomAppData in qml.

Item {
    id: mainItem
    anchors.fill: parent
    anchors.margins: 5

    readonly property var defaultQuicksaveNames: {
                "Float Quicksave 1": "Quicksave 1",
                "Float Quicksave 2": "Quicksave 2",
                "Float Quicksave 3": "Quicksave 3",
                "Float Quicksave 4": "Quicksave 4",
                "Float Quicksave 5": "Quicksave 5",
                "Float Quicksave 6": "Quicksave 6",
                "IMU Quicksave 1": "IMU Quicksave 1",
                "IMU Quicksave 2": "IMU Quicksave 2"
                }

    property Commands mCommands: VescIf.commands()
    property ConfigParams mMcConf: VescIf.mcConfig()
    property ConfigParams mAppConf: VescIf.appConfig()
    property ConfigParams mCustomConf: VescIf.customConfig(0)
    property var quicksaveNames: []
    property var beep_reason: 0
    

    // property var dialogParent: ApplicationWindow.overlay
    
    Settings {
        id: settingStorage
    }
    
    // Timer 1, 10hz for ble comms
    Timer {
        running: true
        repeat: true
        interval: 100
        
        onTriggered: {
            // Poll app data
            var buffer = new ArrayBuffer(2)
            var dv = new DataView(buffer)
            var ind = 0
            dv.setUint8(ind, 111); ind += 1
            dv.setUint8(ind, 0x1); ind += 1
            mCommands.sendCustomAppData(buffer)
            
         
        }
    }

    Connections {
        target: mCommands
        
        // This function will be called when VESC_IF->send_app_data is used. To
        // send data back mCommands.sendCustomAppData can be used. That data
        // will be received in the function registered with VESC_IF->set_app_data_handler
        onCustomAppDataReceived: {
            // Ints and floats can be extracted like this from the data
            var dv = new DataView(data, 0)
            var ind = 0
            var magicnr = dv.getUint8(ind); ind += 1;
            var msgtype = dv.getUint8(ind); ind += 1;

            if (magicnr != 111) {
                return;
            }
            if (msgtype == 1) {
		var state = dv.getInt8(ind); ind += 1;
                var state_sat = dv.getInt8(ind); ind += 1; 
                var switch_state = dv.getInt8(ind); ind += 1;
              	var new_beep_reason = dv.getInt8(ind); ind += 1;
  		var state_stop = dv.getInt8(ind); ind += 1;
                var adc1 = dv.getFloat32(ind); ind += 4;
                var adc2 = dv.getFloat32(ind); ind += 4;
                var voltage = dv.getFloat32(ind); ind += 4;
                var current = dv.getFloat32(ind); ind += 4;
                var pitch = dv.getFloat32(ind); ind += 4;
                var roll = dv.getFloat32(ind); ind += 4;

                var float_setpoint = dv.getFloat32(ind); ind += 4;
                var float_inputtilt = dv.getFloat32(ind); ind += 4;
                var throttle_val = dv.getFloat32(ind); ind += 4;
                var lastwheelslip = dv.getFloat32(ind); ind += 4; 
                var surge_lasttime = dv.getFloat32(ind); ind += 4; 
                var brake_lasttime = dv.getFloat32(ind); ind += 4; 
                var drop_lasttime = dv.getFloat32(ind); ind += 4; 
	
		var ridetime = dv.getFloat32(ind); ind += 4; //ride time
	        var resttime = dv.getFloat32(ind); ind += 4; //rest time
	 	var distance = dv.getFloat32(ind); ind += 4; //distance
	        var eff = dv.getFloat32(ind); ind += 4; //efficiency
	        var current_avg = dv.getFloat32(ind); ind += 4; //current avg
	        var speed_avg = dv.getFloat32(ind); ind += 4; //speed avg
	        var max_carve_chain = dv.getFloat32(ind); ind += 4; 
	        var carves_mile = dv.getFloat32(ind); ind += 4; //carves per mile
 		var max_roll_avg = dv.getFloat32(ind); ind += 4;
	        var max_yaw_avg = dv.getFloat32(ind); ind += 4;
	        var max_air = dv.getFloat32(ind); ind += 4;
	 	var bonks_total = dv.getFloat32(ind); ind += 4;
	        var drop_max_air = dv.getFloat32(ind); ind += 4;
	 	var last_drop_time = dv.getFloat32(ind); ind += 4;
   
                var debug_state = dv.getInt8(ind); ind += 1; // 1 is traction control, 2 is surge
                if (debug_state == 1) { 
                    var debug1 = dv.getFloat32(ind); ind += 4; // erpmfactor
                    var debug2 = dv.getFloat32(ind); ind += 4; // wheelslipstart
                    var debug3 = dv.getFloat32(ind); ind += 4; //wheelsliplasterpm 
                    var debug4 = dv.getFloat32(ind); ind += 4; // wheelsliperpm 
                    var debug5 = dv.getFloat32(ind); ind += 4; // debugwheelslip 
                    var debug6 = dv.getFloat32(ind); ind += 4; // duration 
                    var debug7 = dv.getFloat32(ind); ind += 4; // count 
                } else if (debug_state == 2) {
                    var debug1 = dv.getFloat32(ind); ind += 4; //surge_startprop 
                    var debug3 = dv.getFloat32(ind); ind += 4; //surge_added duty
                    var debug4 = dv.getFloat32(ind); ind += 4; //surge_start_current 
                    var debug5 = dv.getFloat32(ind); ind += 4; //surge_endangle  
                    var debug6 = dv.getFloat32(ind); ind += 4; //surge_lastcycle  
                    var debug7 = dv.getFloat32(ind); ind += 4; //surge_startcurrent 
		    var debug2 = dv.getFloat32(ind); ind += 4; //ramp rate
                } else if (debug_state == 3) {
		    var debug1 = dv.getFloat32(ind); ind += 4; //smoothpitch
		    var debug2 = dv.getFloat32(ind); ind += 4; //pitch kp
		    var debug3 = dv.getFloat32(ind); ind += 4; //pitch angle demand
		    var debug4 = dv.getFloat32(ind); ind += 4; //pitch rate
        	    var debug5 = dv.getFloat32(ind); ind += 4; //pitch kp rate
		    var debug6 = dv.getFloat32(ind); ind += 4; //pitch rate demand
                } else if (debug_state == 4) {
                    var debug1 = dv.getFloat32(ind); ind += 4; //erpm
                    var debug2 = dv.getFloat32(ind); ind += 4; //stablity 0-100%
		    var debug3 = dv.getFloat32(ind); ind += 4; //added pitch kp 
      		    var debug4 = dv.getFloat32(ind); ind += 4; //added stability rate P for pitch
                    var debug5 = dv.getFloat32(ind); ind += 4; // added stability rate P for yaw		
                    var debug6 = dv.getFloat32(ind); ind += 4; // added demand for pitch angle
                    var debug7 = dv.getFloat32(ind); ind += 4; // added demand for pitch and yaw rate
		} else if (debug_state == 5) {
                    var debug1 = dv.getFloat32(ind); ind += 4; //yaw angle
                    var debug2 = dv.getFloat32(ind); ind += 4; //yaw change
		    var debug3 = dv.getFloat32(ind); ind += 4; //max yaw change
      		    var debug4 = dv.getFloat32(ind); ind += 4; //yaw kp 
                    var debug5 = dv.getFloat32(ind); ind += 4; //yaw kp current demand
                    var debug6 = dv.getFloat32(ind); ind += 4; //yaw rate
                    var debug7 = dv.getFloat32(ind); ind += 4; // yaw rate current demand	
		} else if (debug_state == 6) {
                    var debug1 = dv.getFloat32(ind); ind += 4; //roll angle
                    var debug2 = dv.getFloat32(ind); ind += 4; //max roll
		    var debug3 = dv.getFloat32(ind); ind += 4; // erpm scale
      		    var debug4 = dv.getFloat32(ind); ind += 4; //roll kp
                    var debug5 = dv.getFloat32(ind); ind += 4; //roll current demand
		} else if (debug_state == 7) {
                    var debug1 = dv.getFloat32(ind); ind += 4; // duty
                    var debug2 = dv.getFloat32(ind); ind += 4; // accel
                    var debug3 = dv.getFloat32(ind); ind += 4; // min erpm 
                    var debug4 = dv.getFloat32(ind); ind += 4; // max erpm 
                    var debug5 = dv.getFloat32(ind); ind += 4; // debug 
                    var debug6 = dv.getFloat32(ind); ind += 4; // duration 
                    var debug7 = dv.getFloat32(ind); ind += 4; // end condition 3 sec 
		} else {
		    //space for temporary debugs
                    var debug1 = dv.getFloat32(ind); ind += 4; //drop duration 
                    var debug2 = dv.getFloat32(ind); ind += 4; //applied reduction
	            var debug5 = dv.getFloat32(ind); ind += 4; //drop count	    
                    var debug3 = dv.getFloat32(ind); ind += 4; //end condition  
                    var debug4 = dv.getFloat32(ind); ind += 4; //min accel z 
                    var debug6 = dv.getFloat32(ind); ind += 4; //ending pitch 
                    var debug7 = dv.getFloat32(ind); ind += 4; //duration
		}
		
                var stateString
                if(state == 0){
                    stateString = "DISABLED"	
                }else if(state == 1){
                    stateString = "STARTUP"
                }else if(state == 2){		//If we are in ready state the board has stopped recently, add the stop reason.
                    stateString = "READY";

      		    if(state_stop == 0){
			stateString += "-STARTUP"	
		    }else if(state_stop == 1){
			stateString += "-PITCH"
		    }else if(state_stop == 2){ 
   			stateString += "-ROLL"
		    }else if(state_stop == 3){ 
		        stateString += "-HALF SWITCH"
		    }else if(state_stop == 4){ 
		        stateString += "-FULL SWITCH"
		    }else if(state_stop == 6){ 
		        stateString += "-QUICKSTOP"
		    }else if(state_stop == 7){ 
		        stateString += "-TRACTN CTRL"
	  	    }
		}else if(state == 3){		//If the board is running we can receive setpoint adjustment, add SAT reason.
                    stateString = "RUNNING";

		    if(state_sat == 1){
			stateString += "-CENTERING"
		    }else if(state_sat == 6){ 
   			stateString += "-HIGH DUTY"
		    }else if(state_sat == 10){ 
		        stateString += "-HIGH VOLTAGE"
		    }else if(state_sat == 11){ 
		        stateString += "-LOW VOLTAGE"
		    }else if(state_sat == 12){ 
		        stateString += "-HIGH TEMP"		    	
	  	    }
 
		}else if(state == 4){		
                    stateString = "WHEELSLIP";
		}
		
  		if(new_beep_reason > 0) {
		    beep_reason = new_beep_reason;
		}
                
		var beepString
                if(beep_reason == 1){
                    beepString = "Low Voltage Alert"
                }else if(beep_reason == 2){
                    beepString = "High Voltage Alert"
                }else if(beep_reason == 3){
                    beepString = "High FET Temp"
                }else if(beep_reason == 4){
                    beepString = "High Motor Temp"
                }else if(beep_reason == 5){
                    beepString = "High Current Beep"
                }else if(beep_reason == 6){
                    beepString = "Duty Cycle Beep"
                }else if(beep_reason == 7){
                    beepString = "Foot Sensors"
                }else if(beep_reason == 8){
                    beepString = "Low Battery"
                }else if(beep_reason == 9){
                    beepString = "Board Idle"
                }else if(beep_reason == 10){
                    beepString = "Other"
                }else if(beep_reason == 11){
                    beepString = "High Current Tone"
                }else if(beep_reason == 12){
                    beepString = "Duty Cycle Tone"
                }else if(beep_reason == 13){
                    beepString = "Mid Range Warning"
		}else if(beep_reason == 14){
                    beepString = "Low Range Warning"
                }else if(beep_reason == 15){
                    beepString = "FET Temp Recovery"
		}else if(beep_reason == 16){
                    beepString = "Motor Temp Recovery"
		}else if(beep_reason == 17){
                    beepString = "Charge Complete"
		}
  
                var switchString
                if(switch_state == 0){
                    switchString = "Off"
                }else if(switch_state == 1){
                    switchString = "Half"
                }else if(switch_state == 2){
                    switchString = "Half"
		}else{
                    switchString = "On"
                }

  		var wheelsliptime1 = ("0" + Math.trunc(lastwheelslip/3600)).slice(-2);
    		var wheelsliptime2 = ("0" + Math.trunc(lastwheelslip/60 - wheelsliptime1*60)).slice(-2);
    		var wheelsliptime3 = ("0" + Math.trunc(lastwheelslip - wheelsliptime1*3600 - wheelsliptime2*60)).slice(-2);
  		var surgetime1 = ("0" + Math.trunc(surge_lasttime/3600)).slice(-2);
    		var surgetime2 = ("0" + Math.trunc(surge_lasttime/60 - surgetime1*60)).slice(-2);
    		var surgetime3 = ("0" + Math.trunc(surge_lasttime - surgetime1*3600 - surgetime2*60)).slice(-2);
        	var ridetime1 = ("0" + Math.trunc(ridetime/3600)).slice(-2);
    		var ridetime2 = ("0" + Math.trunc(ridetime/60 - ridetime1*60)).slice(-2);
    		var ridetime3 = ("0" + Math.trunc(ridetime - ridetime1*3600 - ridetime2*60)).slice(-2);
        	var resttime1 = ("0" + Math.trunc(resttime/3600)).slice(-2);
    		var resttime2 = ("0" + Math.trunc(resttime/60 - resttime1*60)).slice(-2);
    		var resttime3 = ("0" + Math.trunc(resttime - resttime1*3600 - resttime2*60)).slice(-2);
              	var braketime1 = ("0" + Math.trunc(brake_lasttime/3600)).slice(-2);
    		var braketime2 = ("0" + Math.trunc(brake_lasttime/60 - braketime1*60)).slice(-2);
    		var braketime3 = ("0" + Math.trunc(brake_lasttime - braketime1*3600 - braketime2*60)).slice(-2);
               	var droptime1 = ("0" + Math.trunc(drop_lasttime/3600)).slice(-2);
    		var droptime2 = ("0" + Math.trunc(drop_lasttime/60 - droptime1*60)).slice(-2);
    		var droptime3 = ("0" + Math.trunc(drop_lasttime - droptime1*3600 - droptime2*60)).slice(-2);
      
                if(state == 0){
                    stateString = "DISABLED"
                    switchString = "Enable in TNT Cfg: Specs"
                    rt_state.text = "TNT Package is Disabled\n\n" +
                                    "You can re-enable it in\nTNT Cfg: Specs\n\n"
                    tune.text = "-- n/a --"
                    trip.text = "-- n/a --"
                    debug.text = "-- n/a --"
                } else {
	                rt_state.text =
	                    "State               : " + stateString + "\n" +
	                    "Switch              : " + switchString + "\n" +
	                    "ADC1 / ADC2         : " + adc1.toFixed(2) + "V / " + adc2.toFixed(2) + "V\n" +
	                    "Last Beep Reason    : " + beepString + "\n" +
	                    "Voltage             : " + voltage.toFixed(2) + "V\n" +
	                    "Current             : " + current.toFixed(1) + " A\n" +
			    "Pitch               : " + pitch.toFixed(2) + "°\n" +
	   		    "Roll                : " + roll.toFixed(2) + "°\n" 
	                
	                tune.text =
	                    "Remote Input        : " + (throttle_val * 100).toFixed(0) + "%\n" +
	                    "Setpoint            : " + float_setpoint.toFixed(2) + "°\n" +
	                    "RemoteTilt Setpoint : " + float_inputtilt.toFixed(2) + "°\n" +
	                    "Last Wheelslip Time : " + wheelsliptime1 + ":" + wheelsliptime2 + ":" + wheelsliptime3 + "\n" +                
	                    "Last Surge Time     : " + surgetime1 + ":" + surgetime2 + ":" + surgetime3 + "\n" +
	                    "Last Traction Brake : " + braketime1 + ":" + braketime2 + ":" + braketime3 + "\n" + 
	                    "Last Drop Time      : " + droptime1 + ":" + droptime2 + ":" + droptime3 + "\n"       
		     
	                trip.text =
	                    "Ride Time          : " + ridetime1 + ":" + ridetime2 + ":" + ridetime3 + "\n" +
	                    "Rest Time          : " + resttime1 + ":" + resttime2 + ":" + resttime3 + "\n" +
	                    "Distance           : " + distance.toFixed(2) + " mi\n" +
			    "Efficiency         : " + eff.toFixed(1) + " Wh/mi\n" +
		            "Current Average    : " + current_avg.toFixed(1) + " A\n" +
		     	    "Speed Average      : " + speed_avg.toFixed(1) + " mph\n" +
		     	    "Max Carve Chain    : " + max_carve_chain.toFixed(0) + " \n" +
	                    "Carves per Mile    : " + carves_mile.toFixed(0) + " /mi\n" +
		     	    "Roll Average       : " + max_roll_avg.toFixed(1) + " °\n" +
		     	    "Yaw Average        : " + max_yaw_avg.toFixed(0) + " °/s\n" +
		     	    "Max Air Time       : " + max_air.toFixed(2) + " s\n" +
		     	    "Air Time Total     : " + bonks_total.toFixed(0) + " \n" +
		     	    "Drop Max Air Time  : " + drop_max_air.toFixed(2) + " s\n" +
		     	    "Last Drop Time     : " + last_drop_time.toFixed(2) + " s\n" 
	    
			if (debug_state == 1) {
				debug.text =
				"ERPM Average        : " + debug1.toFixed(0) + "\n" +  
				"ERPM Average        : " + debug2.toFixed(0) + " ERPM/ms\n" +
				"Start ERPM          : " + debug4.toFixed(0) + " ERPM\n" +
				"Last ERPM           : " + debug3.toFixed(0) + " ERPM\n" +
				"End Condition       : " + debug5.toFixed(0) + "\n" +
				"Last Duration       : " + debug6.toFixed(3) + " s\n" +
				"Wheelslip Count     : " + debug7.toFixed(0) + "\n" +
    				"End Conditions \n 1 - Accel Direction Change \n 2 - Accel Magnitude Change \n 3 - Reverse Direction \n 4 - Pitch Angle Limit \n 5 - 1 Second Timeout \n 6 - Traction Braking \n"
	                } else if (debug_state == 2) {
				debug.text =
				"Start Current       : " + debug7.toFixed(0) + " A\n" +
				"Start Threshold     : " + debug4.toFixed(0) + " A\n" +
				"Start Proportional  : " + debug1.toFixed(1) + " °\n" +
				"Duty Ramp Rate      : " + debug2.toFixed(0) + " %/s\n" +
				"Added Duty          : " + (debug3 * 100).toFixed(1) + " %\n" +
				"End Proportional    : " + debug5.toFixed(1) + " °\n" +
				"Last Surge Duration : " + debug6.toFixed(3) + " s\n" +
            			"End Conditions \n #.# - End Pitch Angle \n 111 - 500ms Timeout \n 222 - Wheelslip Detected \n"
			} else if (debug_state == 3) {
				debug.text =
				"Filtered Pitch Angle: " + debug1.toFixed(2) + " °\n" +
    				"Pitch Angle Kp      : " + debug2.toFixed(2) + " \n" +
    				"Pitch Angle Current : " + debug3.toFixed(1) + " A\n" +         
				"Pitch Rate          : " + debug4.toFixed(0) + " °/s\n" + 
				"Pitch Rate Kp       : " + debug5.toFixed(2) + " \n" +
				"Pitch Rate Current  : " + debug6.toFixed(1) + " A\n" 
			} else if (debug_state == 4) {
				debug.text =
				"Absolute ERPM       : " + debug1.toFixed(0) + " ERPM \n" +
    				"Stability           : " + debug2 * 100.toFixed(0) + " % \n" +
 				"Pitch Angle Kp      : " + debug3.toFixed(2) + " \n" +
				"Pitch Rate Kp       : " + debug4.toFixed(2) + " \n" +         
     				"Yaw Rate Kp         : " + debug5.toFixed(2) + " \n" +
     				"Pitch Angle Current : " + debug6.toFixed(1) + " A\n" +
    				"Pitch/Yaw Rate Curre: " + debug7.toFixed(1) + " A\n" 
			} else if (debug_state == 5) {
				debug.text =
				"Yaw Angle           : " + debug1.toFixed(1) + " ° \n" +
				"Yaw Change          : " + debug2.toFixed(0) + " °/s \n" +         
     				"Max Yaw Change      : " + debug3.toFixed(0) + " °/s \n" +
     				"Yaw Change Kp       : " + debug4.toFixed(2) + " \n" +
    				"Yaw Change Current  : " + debug5.toFixed(1) + " A\n" +    
				"Yaw Rate            : " + debug6.toFixed(0) + " °/s \n" +
				"Yaw Rate Current    : " + debug7.toFixed(1) + " A\n" 
			} else if (debug_state == 6) {
				debug.text =
				"Roll Angle          : " + debug1.toFixed(1) + " ° \n" +
				"Max Roll Angle      : " + debug2.toFixed(0) + " °/s \n" +         
     				"ERPM Scaler         : " + debug3.toFixed(0) + "  \n" +
     				"Roll Angle Kp       : " + debug4.toFixed(2) + " \n" +
    				"Roll Angle Current  : " + debug5.toFixed(1) + " A\n"  
    			} else if (debug_state == 7) {
				debug.text =
				"Battery Current     : " + debug1.toFixed(0) + " A\n" +  
				"Max Acceleration    : " + debug2.toFixed(1) + " ERPM/ms\n" +
				"Min ERPM            : " + debug3.toFixed(0) + " ERPM\n" +
				"Max ERPM            : " + debug4.toFixed(0) + " ERPM\n" +
				"End Condition       : " + debug5.toFixed(0) + "\n" +
				"End Cond, 1 sec min : " + debug7.toFixed(0) + "\n" +
				"Total Duration      : " + debug6.toFixed(1) + " s\n" +
        			"End Conditions \n 1 - Remote Pitch Angle \n 2 - Battery Current \n 3 - Minimum Duty \n 4 - Vq-Iq \n 5 - Minimum ERPM \n 6 - IMU Position \n 7 - Motor Current \n"
			} else if (debug_state == 8) {
				debug.text =
     				"Pitch Angle Current : " + debug1.toFixed(1) + " A\n" +
    				"Pitch Rate Current  : " + debug2.toFixed(1) + " A\n" +  
    				"Yaw Change Current  : " + debug3.toFixed(1) + " A\n" +    
				"Yaw Rate Current    : " + debug4.toFixed(1) + " A\n" +
    				"Roll Angle Current  : " + debug5.toFixed(1) + " A\n" +    
     				"Stability Angle Curr: " + debug6.toFixed(1) + " A\n" +
    				"Stability Rate Curre: " + debug7.toFixed(1) + " A\n" 
    			} else { 
				debug.text = 
				"Accel Z             : " + debug1.toFixed(2) + " g\n" +
				"Pitch/Roll Factor   : " + debug2.toFixed(2) + " \n" +
				"Drop Count          : " + debug5.toFixed(0) + " \n" +         
				"Drop End Condition  : " + debug3.toFixed(2) + " \n" +         
				"Min Accel Z         : " + debug4.toFixed(2) + " \n" + 
				"Ending Pitch        : " + debug6.toFixed(1) + "°\n" +
				"Drop Duration       : " + debug7.toFixed(3) + " s\n" 
	  		}
                }
            }
        }
    }

    Component.onCompleted: {
        restoreQuicksaveNames()
        restoreDownloadedTunes()
    }

    Dialog {
        id: quicksavePopup
        title: saveName
        standardButtons: Dialog.Save | Dialog.Discard | Dialog.Cancel
        modal: true
        focus: true
        width: parent.width - 20
        closePolicy: Popup.CloseOnEscape
        x: 10
        y: 10 + parent.height / 2 - height / 2
        parent: ApplicationWindow.overlay
        onAccepted: {
            if(quicksaveNameInput.text){
                quicksaveNames[saveName] = quicksaveNameInput.text
                quicksaveNames = quicksaveNames
                settingStorage.setValue("quicksave_names", JSON.stringify(quicksaveNames))
            }
            settingStorage.setValue(saveName, saveValue)
           
            quicksaveNameInput.text = ""
            VescIf.emitStatusMessage(saveName + " saved!", true)
        }
        onDiscarded: {
            VescIf.emitStatusMessage(quicksaveNames[saveName] + " discarded", true)

            quicksaveNames[saveName] = defaultQuicksaveNames[saveName]
            quicksaveNames = quicksaveNames
            settingStorage.setValue("quicksave_names", JSON.stringify(quicksaveNames))
            settingStorage.setValue(saveName, null)

            quicksaveNameInput.text = ""
            close()
        }
        onRejected: {
            quicksaveNameInput.text = ""
            VescIf.emitStatusMessage(saveName + " cancelled", false)
        }
        property var saveName: "Temp Name"
        property var saveValue: ""

        Overlay.modal: Rectangle {
            color: "#AA000000"
        }

        ColumnLayout {
            anchors.fill: parent
            Text {
                color: Utility.getAppHexColor("lightText")
                verticalAlignment: Text.AlignVCenter
                Layout.fillWidth: true
                wrapMode: Text.WordWrap
                text: "Do you want to overwrite this slot?"
            }
            TextField {
                id: quicksaveNameInput
                placeholderText: qsTr("Quicksave name (optional)")
                Layout.fillWidth: true
            }
        }
    }

    Dialog {
        id: downloadedTunePopup
        title: tune._name
        standardButtons: Dialog.Apply | Dialog.Cancel
        modal: true
        focus: true
        width: parent.width - 20
        closePolicy: Popup.CloseOnEscape
        x: 10
        y: 10 + parent.height / 2 - height / 2
        parent: ApplicationWindow.overlay
        onApplied: {
            applyDownloadedTune(tune)
            VescIf.emitStatusMessage(tune._name + " applied!", true)
            close()
        }
        onRejected: VescIf.emitStatusMessage(tune._name + " cancelled", false)
        property var tune: ""

        Overlay.modal: Rectangle {
            color: "#AA000000"
        }

        ColumnLayout {
            anchors.fill: parent
            Text {
                color: Utility.getAppHexColor("lightText")
                verticalAlignment: Text.AlignVCenter
                Layout.fillWidth: true
                wrapMode: Text.WordWrap
                text: "Applying this tune will OVERWRITE your current tune. Be sure to have a back-up ready if you would like to revert back at any time. Would you like to apply this tune?"
            }
        }
    }

    Dialog {
        id: quickloadErrorPopup
        title: "Quicksave Empty"
        standardButtons: Dialog.Ok
        modal: true
        focus: true
        width: parent.width - 20
        closePolicy: Popup.CloseOnEscape
        x: 10
        y: 10 + parent.height / 2 - height / 2
        parent: ApplicationWindow.overlay
        
        Overlay.modal: Rectangle {
            color: "#AA000000"
        }
        
        Text {
            color: Utility.getAppHexColor("lightText")
            verticalAlignment: Text.AlignVCenter
            anchors.fill: parent
            wrapMode: Text.WordWrap
            text: "Long Press a Quicksave slot to name and save your current tune, then tap it anytime to apply it instantly."
        }
    }

    ColumnLayout {
        id: root
        anchors.fill: parent
    

        TabBar {
            id: tabBar
            currentIndex: 0
            Layout.fillWidth: true
            clip: true
            enabled: true

            background: Rectangle {
                opacity: 1
                color: {color = Utility.getAppHexColor("lightBackground")}
            }
            property int buttons: 2
            property int buttonWidth: 120

            Repeater {
                model: ["RT Data", "Tunes"]
                TabButton {
                    text: modelData
                    onClicked:{
                        stackLayout.currentIndex = index
                    }
                }
            }
        }
        
        StackLayout {
            id: stackLayout
            Layout.fillWidth: true
            Layout.fillHeight: true
            // onCurrentIndexChanged: {tabBar.currentIndex = currentIndex

            ColumnLayout { // RT Data Page
                id: rtDataColumn
                
                ScrollView {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    clip: true
                    
                    ColumnLayout {
                        Text {
                            id: header0
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 0
                            Layout.fillWidth: true
                            text: "Board State"
                            font.underline: true
                            font.weight: Font.Black
                            font.pointSize: 14
                        }
                        Text {
                            id: rt_state
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 5
                            Layout.preferredWidth: parent.width/3
                            text: "Waiting for RT Data"
                        }
                        Text {
                            id: header1
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 0
                            Layout.fillWidth: true
                            text: "Tune Modifiers"
                            font.underline: true
                            font.weight: Font.Black
                            font.pointSize: 14
                        }
                        Text {
                            id: tune
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 5
                            Layout.preferredWidth: parent.width/3
                            text: "-\n"
                        }
                        Text {
                            id: header2
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 0
                            Layout.fillWidth: true
                            text: "Trip"
                            font.underline: true
                            font.weight: Font.Black
                            font.pointSize: 14
                        }
                        Text {
                            id: trip
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 5
                            Layout.preferredWidth: parent.width/3
                            text: "-\n"
                        }
                        Text {
                            id: header3
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 0
                            Layout.fillWidth: true
                            text: "Debug"
                            font.underline: true
                            font.weight: Font.Black
                            font.pointSize: 14
                        }
                        Text {
                            id: debug
                            color: Utility.getAppHexColor("lightText")
                            font.family: "DejaVu Sans Mono"
                            Layout.margins: 0
                            Layout.leftMargin: 5
                            Layout.preferredWidth: parent.width/3
                            text: "-"
                        }
                    }
                }
            }

            ColumnLayout { // Tunes Page
                id: tunesColumn
/*
                Text {
                    id: floatQuicksaveHeader
                    color: Utility.getAppHexColor("lightText")
                    font.family: "DejaVu Sans Mono"
                    Layout.margins: 0
                    Layout.fillWidth: true
                    text: "Trick n Trail Package Quicksave Slots"
                    font.underline: true
                    font.weight: Font.Black
                    font.pointSize: 14
                }

                GridLayout {
                    Layout.fillWidth: true
                    columns: 3
                    Repeater {
                        model: [
                            "TNT Quicksave 1", "TNT Quicksave 2", "TNT Quicksave 3",
                            "TNT Quicksave 4", "TNT Quicksave 5", "TNT Quicksave 6"
                        ]
                        Button {
                            text: quicksaveNames[modelData]
                            Layout.fillWidth: true
                            Layout.preferredWidth: 0
                            onPressAndHold: {
                                quicksaveFloat(modelData)
                            }
                            onClicked: {
                                quickloadFloat(modelData)
                            }
                        }
                    }
                }
*/
                Text {
                    id: imuQuicksaveHeader
                    color: Utility.getAppHexColor("lightText")
                    font.family: "DejaVu Sans Mono"
                    Layout.margins: 0
                    Layout.fillWidth: true
                    text: "IMU Config Quicksave Slots"
                    font.underline: true
                    font.weight: Font.Black
                    font.pointSize: 14
                }

                GridLayout {
                    Layout.fillWidth: true
                    columns: 2
                    Repeater {
                        model: ["IMU Quicksave 1", "IMU Quicksave 2"]
                        Button {
                            text: quicksaveNames[modelData]
                            Layout.fillWidth: true
                            Layout.preferredWidth: 0
                            onPressAndHold: {
                                quicksaveIMU(modelData)
                            }
                            onClicked: {
                                quickloadIMU(modelData)
                            }
                        }
                    }
                }
/*
                RowLayout {
                    Layout.fillWidth: true

                    Text {
                        id: tunesHeader
                        color: Utility.getAppHexColor("lightText")
                        font.family: "DejaVu Sans Mono"
                        Layout.margins: 0
                        Layout.fillWidth: true
                        text: "Tunes Archive"
                        font.underline: true
                        font.weight: Font.Black
                        font.pointSize: 14
                    }

                    Button {
                        id: downloadTunesButton
                        text: "Refresh"
                        Layout.alignment: Qt.AlignCenter
                        onClicked: {
                            downloadTunesButton.text = "Downloading Tunes..."
                            downloadedTunesModel.clear()
                            var http = new XMLHttpRequest()
                            // var url = "http://docs.google.com/spreadsheets/d/1bPH-gviDFyXvxx5s2cjs5BWTjqJOmRqB4Xi59itxbJ8/export?format=csv"
                            var url = "http://us-central1-mimetic-union-377520.cloudfunctions.net/float_package_tunes_via_http"
                            http.open("GET", url, true);
                            http.onreadystatechange = function() {
                                if (http.readyState == XMLHttpRequest.DONE) {
                                    downloadTunesButton.text = "Refresh"
                                    if (http.status == 200) {
                                        settingStorage.setValue("tunes_csv", http.responseText)
                                        restoreDownloadedTunes()
                                        VescIf.emitStatusMessage("Tune Download Success", true)
                                    } else {
                                        VescIf.emitStatusMessage("Tune Download Failed: " + http.status, false)
                                    }
                                }
                            }
                            http.send()
                        }
                    }
                }

                ListView {
                    id: downloadedTunesList
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    spacing: 5

                    model: ListModel {
                        id: downloadedTunesModel
                    }
                    delegate: Button {
                        text: tune._name
                        width: parent.width
                        onClicked: {
                            downloadedTunePopup.tune = tune
                            downloadedTunePopup.open()
                        }
                    }
                }
*/
            }
                
        }
    }

    function quicksaveFloat(saveName){
        var params = [
            // {"name": "float_version", "type": "Double"},
            // {"name": "float_disable", "type": "Double"},
            {"name": "kp", "type": "Double"},
            {"name": "ki", "type": "Double"},
            {"name": "kd", "type": "Double"},
            {"name": "kp2", "type": "Double"},
            {"name": "mahony_kp", "type": "Double"},
            // {"name": "hertz", "type": "Int"},
            {"name": "fault_pitch", "type": "Double"},
            {"name": "fault_roll", "type": "Double"},
            // {"name": "fault_adc1", "type": "Double"},
            // {"name": "fault_adc2", "type": "Double"},
            {"name": "fault_delay_pitch", "type": "Int"},
            {"name": "fault_delay_roll", "type": "Int"},
            {"name": "fault_delay_switch_half", "type": "Int"},
            {"name": "fault_delay_switch_full", "type": "Int"},
            {"name": "fault_adc_half_erpm", "type": "Int"},
            {"name": "fault_is_dual_switch", "type": "Bool"},
            {"name": "fault_moving_fault_disabled", "type": "Bool"},
            {"name": "fault_darkride_enabled", "type": "Bool"},
            {"name": "fault_reversestop_enabled", "type": "Bool"},
            {"name": "tiltback_duty_angle", "type": "Double"},
            {"name": "tiltback_duty_speed", "type": "Double"},
            {"name": "tiltback_duty", "type": "Double"},
            {"name": "tiltback_hv_angle", "type": "Double"},
            {"name": "tiltback_hv_speed", "type": "Double"},
            // {"name": "tiltback_hv", "type": "Double"},
            {"name": "tiltback_lv_angle", "type": "Double"},
            {"name": "tiltback_lv_speed", "type": "Double"},
            // {"name": "tiltback_lv", "type": "Double"},
            {"name": "tiltback_return_speed", "type": "Double"},
            {"name": "tiltback_constant", "type": "Double"},
            {"name": "tiltback_constant_erpm", "type": "Int"},
            {"name": "tiltback_variable", "type": "Double"},
            {"name": "tiltback_variable_max", "type": "Double"},
            {"name": "tiltback_variable_erpm", "type": "Int"},
            // {"name": "inputtilt_remote_type", "type": "Enum"},
            {"name": "inputtilt_speed", "type": "Double"},
            {"name": "inputtilt_angle_limit", "type": "Double"},
            {"name": "inputtilt_smoothing_factor", "type": "Int"},
            {"name": "inputtilt_invert_throttle", "type": "Bool"},
            // {"name": "inputtilt_deadband", "type": "Double"},
            {"name": "remote_throttle_current_max", "type": "Double"},
            {"name": "remote_throttle_grace_period", "type": "Double"},
            {"name": "noseangling_speed", "type": "Double"},
            {"name": "startup_pitch_tolerance", "type": "Double"},
            {"name": "startup_roll_tolerance", "type": "Double"},
            {"name": "startup_speed", "type": "Double"},
            {"name": "startup_click_current", "type": "Double"},
            {"name": "startup_simplestart_enabled", "type": "Bool"},
            {"name": "startup_pushstart_enabled", "type": "Bool"},
            {"name": "startup_dirtylandings_enabled", "type": "Bool"},
            {"name": "brake_current", "type": "Double"},
            {"name": "ki_limit", "type": "Double"},
            {"name": "booster_angle", "type": "Double"},
            {"name": "booster_ramp", "type": "Double"},
            {"name": "booster_current", "type": "Double"},
            {"name": "brkbooster_angle", "type": "Double"},
            {"name": "brkbooster_ramp", "type": "Double"},
            {"name": "brkbooster_current", "type": "Double"},
            {"name": "torquetilt_start_current", "type": "Double"},
            {"name": "torquetilt_angle_limit", "type": "Double"},
            {"name": "torquetilt_on_speed", "type": "Double"},
            {"name": "torquetilt_off_speed", "type": "Double"},
            {"name": "torquetilt_strength", "type": "Double"},
            {"name": "torquetilt_strength_regen", "type": "Double"},
            {"name": "atr_strength_up", "type": "Double"},
            {"name": "atr_strength_down", "type": "Double"},
            {"name": "atr_threshold_up", "type": "Double"},
            {"name": "atr_threshold_down", "type": "Double"},
            {"name": "atr_torque_offset", "type": "Double"},
            {"name": "atr_speed_boost", "type": "Double"},
            {"name": "atr_angle_limit", "type": "Double"},
            {"name": "atr_on_speed", "type": "Double"},
            {"name": "atr_off_speed", "type": "Double"},
            {"name": "atr_response_boost", "type": "Double"},
            {"name": "atr_transition_boost", "type": "Double"},
            {"name": "atr_filter", "type": "Double"},
            // {"name": "atr_amps_accel_ratio", "type": "Double"},
            // {"name": "atr_amps_decel_ratio", "type": "Double"},
            {"name": "braketilt_strength", "type": "Double"},
            {"name": "braketilt_lingering", "type": "Double"},
            {"name": "turntilt_strength", "type": "Double"},
            {"name": "turntilt_angle_limit", "type": "Double"},
            {"name": "turntilt_start_angle", "type": "Double"},
            {"name": "turntilt_start_erpm", "type": "Int"},
            {"name": "turntilt_speed", "type": "Double"},
            {"name": "turntilt_erpm_boost", "type": "Int"},
            {"name": "turntilt_erpm_boost_end", "type": "Int"},
            {"name": "turntilt_yaw_aggregate", "type": "Int"},
            // {"name": "dark_pitch_offset", "type": "Double"},
            {"name": "is_buzzer_enabled", "type": "Bool"},
            {"name": "is_dutybuzz_enabled", "type": "Bool"},
            {"name": "is_footbuzz_enabled", "type": "Bool"},
            {"name": "is_surgebuzz_enabled", "type": "Bool"},
            {"name": "surge_duty_start", "type": "Double"},
            {"name": "surge_angle", "type": "Double"}
        ]
        for(var i in params){
            if(params[i].type == ("Double")){
                params[i].value = mCustomConf.getParamDouble(params[i].name)
            }else if(params[i].type == ("Int")){
                params[i].value = mCustomConf.getParamInt(params[i].name)
            }else if(params[i].type == ("Bool")){
                params[i].value = mCustomConf.getParamBool(params[i].name)
            }else if(params[i].type == ("Enum")){
                params[i].value = mCustomConf.getParamEnum(params[i].name)
            }
        }

        quicksavePopup.saveName = saveName
        quicksavePopup.saveValue = JSON.stringify(params)
        quicksavePopup.open()
    }

    function quickloadFloat(saveName){
        var json = settingStorage.value(saveName, "")
        if(!json){
            quickloadErrorPopup.open()
        }else{
            var params = JSON.parse(json)
            for(var i in params){
                if(params[i].type == ("Double")){
                    mCustomConf.updateParamDouble(params[i].name, params[i].value)
                }else if(params[i].type == ("Int")){
                    mCustomConf.updateParamInt(params[i].name, params[i].value)
                }else if(params[i].type == ("Bool")){
                    mCustomConf.updateParamBool(params[i].name, params[i].value)
                }else if(params[i].type == ("Enum")){
                    mCustomConf.updateParamEnum(params[i].name, params[i].value)
                }
            }
            mCommands.customConfigSet(0, mCustomConf)
        }
    }

    function quicksaveIMU(saveName){
        var params = [
            {"name": "imu_conf.mode", "type": "Enum"},
            {"name": "imu_conf.filter", "type": "Enum"},
            {"name": "imu_conf.accel_lowpass_filter_x", "type": "Double"},
            {"name": "imu_conf.accel_lowpass_filter_y", "type": "Double"},
            {"name": "imu_conf.accel_lowpass_filter_z", "type": "Double"},
            {"name": "imu_conf.gyro_lowpass_filter", "type": "Double"},
            {"name": "imu_conf.sample_rate_hz", "type": "Int"},
            {"name": "imu_conf.use_magnetometer", "type": "Bool"},
            {"name": "imu_conf.accel_confidence_decay", "type": "Double"},
            {"name": "imu_conf.mahony_kp", "type": "Double"},
            {"name": "imu_conf.mahony_ki", "type": "Double"},
            {"name": "imu_conf.madgwick_beta", "type": "Double"},
            {"name": "imu_conf.rot_roll", "type": "Double"},
            {"name": "imu_conf.rot_pitch", "type": "Double"},
            {"name": "imu_conf.rot_yaw", "type": "Double"},
            {"name": "imu_conf.accel_offsets__0", "type": "Double"},
            {"name": "imu_conf.accel_offsets__1", "type": "Double"},
            {"name": "imu_conf.accel_offsets__2", "type": "Double"},
            {"name": "imu_conf.gyro_offsets__0", "type": "Double"},
            {"name": "imu_conf.gyro_offsets__0", "type": "Double"},
            {"name": "imu_conf.gyro_offsets__0", "type": "Double"}
        ]
        for(var i in params){
            if(params[i].type == ("Double")){
                params[i].value = mAppConf.getParamDouble(params[i].name)
            }else if(params[i].type == ("Int")){
                params[i].value = mAppConf.getParamInt(params[i].name)
            }else if(params[i].type == ("Bool")){
                params[i].value = mAppConf.getParamBool(params[i].name)
            }else if(params[i].type == ("Enum")){
                params[i].value = mAppConf.getParamEnum(params[i].name)
            }
        }

        quicksavePopup.saveName = saveName
        quicksavePopup.saveValue = JSON.stringify(params)
        quicksavePopup.open()
    }

    function quickloadIMU(saveName){
        var json = settingStorage.value(saveName, "")
        if(!json){
            quickloadErrorPopup.open()
        }else{
            var params = JSON.parse(json)
            for(var i in params){
                if(params[i].type == ("Double")){
                    mAppConf.updateParamDouble(params[i].name, params[i].value)
                }else if(params[i].type == ("Int")){
                    mAppConf.updateParamInt(params[i].name, params[i].value)
                }else if(params[i].type == ("Bool")){
                    mAppConf.updateParamBool(params[i].name, params[i].value)
                }else if(params[i].type == ("Enum")){
                    mAppConf.updateParamEnum(params[i].name, params[i].value)
                }
            }
            mCommands.setAppConf()
        }
    }

    function restoreDownloadedTunes(){
        var tunes = parseCSV(settingStorage.value("tunes_csv", ""))
        for(var i in tunes){
            downloadedTunesModel.append({"tune": tunes[i]})
        }
    }

    function parseCSV(csv){
        var lines=csv.split("\r\n");
        var result = [];
        var tuneCount = lines[0].split(",").length - 1;

        for(var i=0; i < tuneCount; i++){
            result.push({})
        }

        for(var i=0; i<lines.length; i++) {
            var currentLine=lines[i].split(",")
            for(var j=0; j < tuneCount; j++) {
                if(currentLine[j+1]){
                    result[j][currentLine[0]] = currentLine[j+1]
                }
            }
        }

        return result; //JavaScript object
        // return JSON.stringify(result); //JSON
    }

    function applyDownloadedTune(tune){
        for (const [key, value] of Object.entries(tune)) {
            if(!key.startsWith("_")){
                var actualKey
                if(key.startsWith("double_")){
                    mCustomConf.updateParamDouble(key.substring(7), value)
                }else if(key.startsWith("int_")){
                    mCustomConf.updateParamInt(key.substring(4), value)
                }else if(key.startsWith("bool_")){
                    mCustomConf.updateParamBool(key.substring(5), parseInt(value))
                }else if(key.startsWith("enum_")){
                    mCustomConf.updateParamEnum(key.substring(5), value)
                }
                mCommands.customConfigSet(0, mCustomConf)
            }
        }
    }

    function restoreQuicksaveNames(){
        var json = settingStorage.value("quicksave_names", "")
        if(!json){
            quicksaveNames = defaultQuicksaveNames
        }else{
            quicksaveNames = JSON.parse(json)
        }
    }

}
